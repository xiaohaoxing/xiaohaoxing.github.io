import{_ as y}from"./ValaxyMain.vue_vue_type_style_index_0_lang.BOxa4x0W.js";import"./chunks/@vueuse/motion.DExMrowK.js";import{e as g,u as o,a as F}from"./chunks/vue-router.BNn-cICo.js";import{aa as u,ap as t,ag as h,af as i,ae as C,ai as s,F as m,ab as D,Z as c}from"./framework.BfPwxjTV.js";import"./app.CvLFRx2e.js";import"./chunks/dayjs.BdcnXKr1.js";import"./chunks/vue-i18n.Bc4ESJIK.js";import"./chunks/pinia.wpQ7btRk.js";import"./chunks/nprogress.0ha8kAew.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.BajIiQUt.js";import"./index.C5okkQwF.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.Dm5vxeuM.js";import"./post.jxfEQmKM.js";const A=g("/posts/a_production_env_accident_Case_Study",async k=>JSON.parse('{"title":"一次线上事故 Case Study","description":"","frontmatter":{"layout":"post","title":"一次线上事故 Case Study","date":"2024-08-13 11:48:32"},"headers":[],"relativePath":"pages/posts/a_production_env_accident_Case_Study.md","lastUpdated":1769141942000}'),{lazy:(k,n)=>k.name===n.name}),Q={__name:"a_production_env_accident_Case_Study",setup(k,{expose:n}){const{data:r}=A(),p=F(),E=o(),e=Object.assign(E.meta.frontmatter||{},r.value?.frontmatter||{});return p.currentRoute.value.data=r.value,c("valaxy:frontmatter",e),globalThis.$frontmatter=e,n({frontmatter:{layout:"post",title:"一次线上事故 Case Study",date:"2024-08-13 11:48:32"}}),(l,a)=>{const d=y;return D(),u(d,{frontmatter:m(e)},{"main-content-md":t(()=>[a[0]||(a[0]=i("h1",{id:"背景",tabindex:"-1"},[s("背景 "),i("a",{class:"header-anchor",href:"#背景","aria-label":'Permalink to "背景"'},"​")],-1)),a[1]||(a[1]=i("p",null,"半夜 12 点，接到同事电话，刚上线的产品有用户反馈买的东西在列表里没有，反馈过来了，需要立即跟进，于是就开始排查相关问题。",-1)),C(" more "),a[2]||(a[2]=i("h1",{id:"排查步骤",tabindex:"-1"},[s("排查步骤 "),i("a",{class:"header-anchor",href:"#排查步骤","aria-label":'Permalink to "排查步骤"'},"​")],-1)),a[3]||(a[3]=i("p",null,"首先第一步是找到原始的 log，同事已经进行了这一步，找到了对应的 logid，并查到了日志。日志显示，支付回调成功了但是资产的状态没有发生变化，怀疑是用订单去找资产的过程中出了问题。",-1)),a[4]||(a[4]=i("p",null,"紧接着，我们去用相关的订单 ID，资产 ID，购买记录 ID 等等数据去找数据库里的数据，发现除了订单因为超时被关闭之外，其他的都仍然是待支付的状态，因此可以断定问题是出在了订单回调后调用业务方法的地方。并且这里使用了 try catch，忽略了中途抛出的异常，导致日志也没有任何线索。",-1)),a[5]||(a[5]=i("p",null,"继续看 sql 日志，很快就发现在查找资产的地方 ID 传入的是错误的，继续排查发现是底层的 repository 层没有处理 source_id 导致的。",-1)),a[6]||(a[6]=i("p",null,"SQL 类似如下格式：",-1)),a[7]||(a[7]=i("div",{class:"language-SQL"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"SQL"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"select"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," *"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," from"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," record "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"where"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," status"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," not"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," in"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"and"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," deleted_time "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"is"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," null"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," limit"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},";")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),a[8]||(a[8]=i("p",null,"可以看出，没有指定的 ID 查询条件，导致查询到错误的记录。",-1)),a[9]||(a[9]=i("p",null,"做出如下的修改即可：",-1)),a[10]||(a[10]=i("div",{class:"language-php"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"php"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// service.php")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getRecordBySource"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"($sourceId)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"    $this"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"repository"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"findOne"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(["),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'source_id'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," =>"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $sourceId]);")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"//repository.php")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," findOne"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"($params)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    $query "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," Record"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"query"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"isset"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"($params["),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'record_id'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"])) {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        $query"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"where"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'record_id'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", $params["),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'record_id'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"])")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"   // 需要这部分代码")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"   if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"isset"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"($params["),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'source_id'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"])) {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"       $query"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"where"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'source_id'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", $params["),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'source_id'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"])")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"+"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"   }")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    ...")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $query"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"first"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),a[11]||(a[11]=i("p",null,[s("看起来是一个低级错误导致的问题，但是解决后仍然无法正常购买和展示，并且报出了找不到记录的错误。再次查看 SQL，发现了奇怪的条件： "),i("code",null,"where status not in (1,2)"),s("。")],-1)),a[12]||(a[12]=i("p",null,"再次查看拼接查询条件的方法，发现了问题所在：",-1)),a[13]||(a[13]=i("div",{class:"language-php"},[i("button",{title:"Copy code",class:"copy"}),i("span",{class:"lang"},"php"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[i("code",{"v-pre":""},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"public"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," function"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," findOne"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"($params)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        $query "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," Record"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"query"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"isset"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"($params["),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'record_id'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"])) {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        $query"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"where"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'record_id'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", $params["),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'record_id'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"])")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"isset"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"($params["),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'source_id'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"])) {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        $query"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"where"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'source_id'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", $params["),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'source_id'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"])")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"    // 问题就出在这")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    if"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"isset"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"($params["),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'status'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"])) {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        $query"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"whereIn"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'status'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", $params["),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'status'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"] "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," ValidStatus"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"valid"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"?"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Status"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"VALID_GROUP"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Status"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"INVALID_GROUP"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},");")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    } "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"else"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"        $query"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"whereNotIn"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'status'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", ["),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Status"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"WAIT_PAY"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Status"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"::"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"PAY_CANCEL"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]);")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    }")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"    return"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $query"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"->"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"first"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"();")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")])])]),i("button",{class:"code-block-unfold-btn"})],-1)),a[14]||(a[14]=i("p",null,"项目中一般通过在 repository 层 if 条件来追加字段的条件，但是这里存在了 else，导致在没有提供 status 过滤条件的时候会将待支付和取消支付状态的记录筛除。本意是在列表查询时提供“全部”、“有效”、“失效”这几种状态的筛选过滤，但是在订单支付成功的回调中，就需要查询状态为“待支付”的特定记录并更新，从而导致查找不到记录，更新失败。",-1)),a[15]||(a[15]=i("h1",{id:"解决方案",tabindex:"-1"},[s("解决方案 "),i("a",{class:"header-anchor",href:"#解决方案","aria-label":'Permalink to "解决方案"'},"​")],-1)),a[16]||(a[16]=i("ol",null,[i("li",null,[i("p",null,"repository 层增加上 source_id 的查询条件。")]),i("li",null,[i("p",null,"将 status 的转换逻辑移除，移动到上层 service 和 controller 层中进行有效/失效到真实状态的转换，确保底层的逻辑场景无关。")]),i("li",null,[i("p",null,"发布上线并再次手动回调支付成功，恢复业务数据。")])],-1)),a[17]||(a[17]=i("h1",{id:"总结经验",tabindex:"-1"},[s("总结经验 "),i("a",{class:"header-anchor",href:"#总结经验","aria-label":'Permalink to "总结经验"'},"​")],-1)),a[18]||(a[18]=i("p",null,"虽然并不是一个很严重的问题，但是可以总结出经验：业务代码中的分层逻辑需要保证底层的模块和业务尽可能解耦，设计成通用的方法。",-1)),a[19]||(a[19]=i("p",null,"目前正在进行的资产的相关业务重构也需要遵循这样的原则，保证底层模块的代码纯粹性。",-1))]),"main-header":t(()=>[h(l.$slots,"main-header")]),"main-header-after":t(()=>[h(l.$slots,"main-header-after")]),"main-nav":t(()=>[h(l.$slots,"main-nav")]),"main-content-before":t(()=>[h(l.$slots,"main-content-before")]),"main-content":t(()=>[h(l.$slots,"main-content")]),"main-content-after":t(()=>[h(l.$slots,"main-content-after")]),"main-nav-before":t(()=>[h(l.$slots,"main-nav-before")]),"main-nav-after":t(()=>[h(l.$slots,"main-nav-after")]),comment:t(()=>[h(l.$slots,"comment")]),footer:t(()=>[h(l.$slots,"footer")]),aside:t(()=>[h(l.$slots,"aside")]),"aside-custom":t(()=>[h(l.$slots,"aside-custom")]),default:t(()=>[h(l.$slots,"default")]),_:3},8,["frontmatter"])}}};export{Q as default,A as usePageData};
