import{_ as E}from"./ValaxyMain.vue_vue_type_style_index_0_lang.BOxa4x0W.js";import"./chunks/@vueuse/motion.DExMrowK.js";import{e as o,u as F,a as y}from"./chunks/vue-router.BNn-cICo.js";import{aa as u,ap as l,ag as t,af as s,ae as C,ai as i,F as m,ab as b,Z as c}from"./framework.BfPwxjTV.js";import"./app.CvLFRx2e.js";import"./chunks/dayjs.BdcnXKr1.js";import"./chunks/vue-i18n.Bc4ESJIK.js";import"./chunks/pinia.wpQ7btRk.js";import"./chunks/nprogress.0ha8kAew.js";/* empty css                    */import"./YunComment.vue_vue_type_style_index_0_lang.BajIiQUt.js";import"./index.C5okkQwF.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang.Dm5vxeuM.js";import"./post.jxfEQmKM.js";const B=o("/posts/GitLab-CI-build_guide",async e=>JSON.parse('{"title":"GitLab CI 搭建指南","description":"","frontmatter":{"title":"GitLab CI 搭建指南","date":"2020-10-26 22:59:58","tags":["教程","技术"]},"headers":[],"relativePath":"pages/posts/GitLab-CI-build_guide.md","lastUpdated":1769141942000}'),{lazy:(e,k)=>e.name===k.name}),M={__name:"GitLab-CI-build_guide",setup(e,{expose:k}){const{data:r}=B(),p=y(),d=F(),h=Object.assign(d.meta.frontmatter||{},r.value?.frontmatter||{});return p.currentRoute.value.data=r.value,c("valaxy:frontmatter",h),globalThis.$frontmatter=h,k({frontmatter:{title:"GitLab CI 搭建指南",date:"2020-10-26 22:59:58",tags:["教程","技术"]}}),(n,a)=>{const g=E;return b(),u(g,{frontmatter:m(h)},{"main-content-md":l(()=>[a[0]||(a[0]=s("h1",{id:"起因",tabindex:"-1"},[i("起因 "),s("a",{class:"header-anchor",href:"#起因","aria-label":'Permalink to "起因"'},"​")],-1)),a[1]||(a[1]=s("p",null,[i("事情的起因也是来自工作中跟我们日常密切相关，而又没有机会接触到的东西：CI。项目脚手架自带了 CI 脚本，只需要稍作修改就可以直接使用；GitLab 上的项目的 CI 配合也不需要我们管，直接使用"),s("code",null,"Public Runner"),i("就行了。时间长了自然就对这方面比较感兴趣，想知道其中的原理。正好搭建了服务器，部署好了 GitLab，于是说干就干，开始着手做自己的 GitLab CI 配置。")],-1)),C(" more "),a[2]||(a[2]=s("h1",{id:"过程",tabindex:"-1"},[i("过程 "),s("a",{class:"header-anchor",href:"#过程","aria-label":'Permalink to "过程"'},"​")],-1)),a[3]||(a[3]=s("h2",{id:"ci-脚本",tabindex:"-1"},[i("CI 脚本 "),s("a",{class:"header-anchor",href:"#ci-脚本","aria-label":'Permalink to "CI 脚本"'},"​")],-1)),a[4]||(a[4]=s("p",null,"已经知道了在项目上执行的东西，包括推代码、打 tag 都会导致 CI 的自动执行，而什么情况执行什么 CI 的 stage 就由项目根目录下的.gitlab-ci.yml 文件决定。因此找到一个项目的 CI 文件看看是怎么写的：",-1)),a[5]||(a[5]=s("div",{class:"language-yml"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"yml"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"image"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"xxxxxx:maven-openjdk8-onbuild")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"stages"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"build")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"  - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"release")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"test"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  stage"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"build")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  script"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"rm -rf test_target/* && mkdir -p test_target && mvn -U clean package -Dmaven.test.skip=true -P test")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"cp -a oms-web/target/oms-web.jar test_target/ROOT.jar")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"chmod +x ./test_target/ROOT.jar")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"cp -rf ./.dockerignore ./test_target && cp -rf ./Dockerfile ./test_target")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  environment"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"test")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  only"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/^neo-java-test-.*$/")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  except"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"branches")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  artifacts"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    paths"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"     - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"test_target/*")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    untracked"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"neo-image-upload"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  stage"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"release")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  image"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"xxxxx:docker19.06-base-image")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  script"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"mi_env=$(echo $CI_COMMIT_TAG | awk -F '-' '{print $3}')")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"cd ./$mi_env'_target'")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"docker login hub.pf.xiaomi.com -u $HUBUSER -p $HUBPASS")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},`docker build . -t  xxxxxx.xxx.xxx/$(echo $CI_COMMIT_TAG | awk -F '-' '{print $2"-"$3}'):$CI_COMMIT_TAG`)]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},`docker push xxxxxxxxx.xxx.xxx]、/$(echo $CI_COMMIT_TAG | awk -F '-' '{print $2"-"$3}'):$CI_COMMIT_TAG`)]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  environment"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"    name"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},": "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"neo")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  only"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/^neo-.*$/")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#22863A","--shiki-dark":"#85E89D"}},"  except"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},":")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"    - "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"branches")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"...")])])]),s("button",{class:"code-block-unfold-btn"})],-1)),a[6]||(a[6]=s("p",null,"首先上来是先定义CI 需要的基本 docker 镜像，不管你 CI 的目的是什么，最终都是要执行一段代码，这部分代码一定需要个环境去执行的，这个环境就是来自于声明的镜像类型。下面是定义了 2 个执行阶段：build 和 release。在 gitlab 平台上 CI 的过程状态图可以知道：这里是定义了他们执行的先后顺序：需要先构建好项目的产出可执行包，再推送到指定的容器中供启动。下面 2 部分则是定义了具体的 stage 的条件和执行的内容。stage：指定为哪个执行阶段。image：指定该阶段使用的镜像。script：该阶段执行的代码，一般为 shell 脚本。only：指定该阶段执行的触发条件，一般为分支或 tag 名。",-1)),a[7]||(a[7]=s("p",null,"根据上面的 ci 脚本，我定义一个最简单的 CI 脚本：",-1)),a[8]||(a[8]=s("div",{class:"language-shell"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"shell"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"image:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," docker:dind")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stages:")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  -"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stage1")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  -"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stage2")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stage-first:")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  stage:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stage1")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  script:")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    -"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," echo"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'I am first executed!'")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  only:")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    -"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," master")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  artifacts:")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    paths:")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"      -"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," prod_target/"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"*")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"stage-second:")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  stage:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," stage2")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  script:")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    -"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," echo"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'I am second executed!'")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"  only:")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"    -"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," master")])])]),s("button",{class:"code-block-unfold-btn"})],-1)),a[9]||(a[9]=s("p",null,"定义了 2 个阶段，分别打印字符串。",-1)),a[10]||(a[10]=s("h2",{id:"ci-runner",tabindex:"-1"},[i("CI Runner "),s("a",{class:"header-anchor",href:"#ci-runner","aria-label":'Permalink to "CI Runner"'},"​")],-1)),a[11]||(a[11]=s("p",null,[i("完成上面的 CI 脚本后我迫不及待的将分支合到 master 并推送到远程，期望他能立刻执行出结果。可是 GitLab 上显示的CI 状态为：Pending：No Runner available for pipeline。表明没有可以用来执行CI 的 Runner。那么就需要查找跟 Runner 相关的信息。得知：Runner 是支持多节点的独立部署的服务，在机器上启动 Runner "),s("strong",null,"管理服务"),i("后"),s("strong",null,"注册"),i("一个新的 Runner，将其"),s("strong",null,"绑定"),i("到对应的 GitLab 上（可以绑定为一个 GitLab 库公用或者一个指定 repository 专用）就可以用来执行 CI 了。")],-1)),a[12]||(a[12]=s("h3",{id:"安装-gitlab-runner",tabindex:"-1"},[i("安装 gitlab-runner "),s("a",{class:"header-anchor",href:"#安装-gitlab-runner","aria-label":'Permalink to "安装 gitlab-runner"'},"​")],-1)),a[13]||(a[13]=s("p",null,"此时我就去找 Runner 的安装了。我直接运行：",-1)),a[14]||(a[14]=s("div",{class:"language-bash"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sudo"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," apt-get"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," install"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," gitlab-runner")])])]),s("button",{class:"code-block-unfold-btn"})],-1)),a[15]||(a[15]=s("p",null,[i("安装成功，"),s("strong",null,"但是"),i("此时执行再执行：")],-1)),a[16]||(a[16]=s("div",{class:"language-bash"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sudo"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," gitlab-runner"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," register")])])]),s("button",{class:"code-block-unfold-btn"})],-1)),a[17]||(a[17]=s("p",null,"想注册一个 Runner 并绑定到我的 GitLab 上发现总是失败。",-1)),a[18]||(a[18]=s("h3",{id:"runner-的坑",tabindex:"-1"},[i("Runner 的坑 "),s("a",{class:"header-anchor",href:"#runner-的坑","aria-label":'Permalink to "Runner 的坑"'},"​")],-1)),a[19]||(a[19]=s("p",null,"经过一番搜索，知道了 GitLab 和 Runner 的版本有约束：8.X 版本的 GitLab 只支持 1.X 版本的 Runner 服务，而 apt 自动安装的为 13.X 版本的了，无法兼容。于是就需要开始搜索互联网上的 1.X 版本的 Runner 安装程序。",-1)),a[20]||(a[20]=s("ul",null,[s("li",null,[s("p",null,"Runner 的 RELEASE：没有 1.X 版本。")]),s("li",null,[s("p",null,"Runner 的 Tag 列表：有 1.X 版本的 tag 但是没有 artifacts 产物。")]),s("li",null,[s("p",null,"各大镜像站：只有 10.X 开始版本的 Runner 安装程序。")])],-1)),a[21]||(a[21]=s("p",null,[i("看似已经山穷水尽了。忽然灵光一现：你虽然可以删除 RELEASE 的旧版本，但是你打版本 tag 的那次 CI 一定有输出到的路径，我就去追溯你那个生成 artifact 的路径不就可以了？果然，被我找到了导出到 AWS 的"),s("a",{href:"https://gitlab-ci-multi-runner-downloads.s3.amazonaws.com/v1.11.5/deb/gitlab-ci-multi-runner_i386.deb",target:"_blank",rel:"noreferrer"},"文件"),i("~")],-1)),a[22]||(a[22]=s("figure",null,[s("img",{src:"https://tva1.sinaimg.cn/large/0081Kckwgy1gk38mj082jj31uh0u0h8v.jpg",alt:"CI product",loading:"lazy",decoding:"async"})],-1)),a[23]||(a[23]=s("p",null,"找到了安装文件后就是顺利的安装过程~直接用命令说明吧：",-1)),a[24]||(a[24]=s("div",{class:"language-bash"},[s("button",{title:"Copy code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"scp"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ~/Downloads/gitlab-ci-multi-runner_i386.deb"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," haoxingxiao@XXX.XXX.XXX.XXX:~/")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ssh"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," XXX.XXX.XXX.XXX")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sudo"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," dpkg"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -i"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," gitlab-ci-multi-runner_i386.deb")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sudo"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," gitlab-runner"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," register")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"gitlab"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," url"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," http://XXXXXXXX.XXX.XXX/ci/    // 注意这里需要提供 /ci 路径")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"token"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," XXXXXXXXXXXXXX")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"runner"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," name"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tencent-cloud-runner")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"tags"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tencent,common")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"allow"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," untagged"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," task?"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," true")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"choose"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," type:docker,shell"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," & "),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"etc.?"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," docker")])])]),s("button",{class:"code-block-unfold-btn"})],-1)),a[25]||(a[25]=s("h2",{id:"执行-ci",tabindex:"-1"},[i("执行 CI "),s("a",{class:"header-anchor",href:"#执行-ci","aria-label":'Permalink to "执行 CI"'},"​")],-1)),a[26]||(a[26]=s("p",null,"配置好 Runner 后就可以在 GitLab 上看到创建成功的 Runner 了:",-1)),a[27]||(a[27]=s("figure",null,[s("img",{src:"https://tva1.sinaimg.cn/large/0081Kckwgy1gk38uzcm7sj31ye0u0dlr.jpg",alt:"Runners",loading:"lazy",decoding:"async"})],-1)),a[28]||(a[28]=s("p",null,"这里我已经把租的阿里云服务器和腾讯云的服务器都配置上去了，构成了多个节点的 Runner 集群，当 CI 任务进入后会自动寻找空闲的 Runner 去执行。其实同一个容器绑定多个 Runner 也可以，不过负载就都在一台容器上了。",-1)),a[29]||(a[29]=s("p",null,"而刚才 Pending 的 CI 也开始执行了。学习了一下 CI 脚本的语法和知识，最终运行的结果如下图：",-1)),a[30]||(a[30]=s("figure",null,[s("img",{src:"https://tva1.sinaimg.cn/large/0081Kckwgy1gk38xonz62j32140kcdhu.jpg",alt:"stages",loading:"lazy",decoding:"async"})],-1)),a[31]||(a[31]=s("figure",null,[s("img",{src:"https://tva1.sinaimg.cn/large/0081Kckwgy1gk38yei629j31i80pqtdh.jpg",alt:"stage1",loading:"lazy",decoding:"async"})],-1)),a[32]||(a[32]=s("p",null,[i("最终达到了搭建自己的自动化 CI 的环境~也利用了开源免费的 "),s("a",{href:"https://shields.io/category/build",target:"_blank",rel:"noreferrer"},"badge 服务"),i(" 给项目的 README 增加了一个构建 CI 状态的徽章：")],-1)),a[33]||(a[33]=s("figure",null,[s("img",{src:"https://tva1.sinaimg.cn/large/0081Kckwgy1gk393be6hqj318u0d4mzd.jpg",alt:"badge",loading:"lazy",decoding:"async"})],-1)),a[34]||(a[34]=s("p",null,"方便直观在项目主页查看状态。",-1)),a[35]||(a[35]=s("h1",{id:"后续",tabindex:"-1"},[i("后续 "),s("a",{class:"header-anchor",href:"#后续","aria-label":'Permalink to "后续"'},"​")],-1)),a[36]||(a[36]=s("p",null,"经过搭建 GitLab 和搭建 GitLab CI 2 步之后，下一步有好几个想要做的东西：",-1)),a[37]||(a[37]=s("ol",null,[s("li",null,"Git Talk 服务"),s("li",null,"创建 Feishu SDK 项目，部署飞书通知的服务，并接入 CI，实现主动推送构建结果到飞书客户端。"),s("li",null,"进一步配置 Blog，目前 Blog 弄的比较仓促，很多信息和配置还没加上去。")],-1)),a[38]||(a[38]=s("p",null,"今天就先写这么多吧~难得有摸鱼的机会弄自己的东西，希望还能一直保持这种热情做下去！☀️",-1))]),"main-header":l(()=>[t(n.$slots,"main-header")]),"main-header-after":l(()=>[t(n.$slots,"main-header-after")]),"main-nav":l(()=>[t(n.$slots,"main-nav")]),"main-content-before":l(()=>[t(n.$slots,"main-content-before")]),"main-content":l(()=>[t(n.$slots,"main-content")]),"main-content-after":l(()=>[t(n.$slots,"main-content-after")]),"main-nav-before":l(()=>[t(n.$slots,"main-nav-before")]),"main-nav-after":l(()=>[t(n.$slots,"main-nav-after")]),comment:l(()=>[t(n.$slots,"comment")]),footer:l(()=>[t(n.$slots,"footer")]),aside:l(()=>[t(n.$slots,"aside")]),"aside-custom":l(()=>[t(n.$slots,"aside-custom")]),default:l(()=>[t(n.$slots,"default")]),_:3},8,["frontmatter"])}}};export{M as default,B as usePageData};
